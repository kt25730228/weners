<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WeNers â€” ì‹¤ì‹œê°„ ê²½ë§¤</title>

  <!-- config.js ëŠ” public/config.js ë¡œ ì´ë¯¸ ì¡´ì¬ (window.SUPABASE_URL / window.SUPABASE_ANON_KEY) -->
  <script src="./config.js"></script>

  <!-- Tailwind via CDN (ê°œë°œìš©) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ â€” ì›ë³¸ ëŠë‚Œ ìœ ì§€í•˜ë ¤ ë…¸ë ¥í•¨ */
    :root { --accent:#06b6d4; --bg:#f8fcff; --muted:#6b7280; }
    html,body{height:100%}
    body{font-family:Inter, "Noto Sans KR", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#0f172a}
    header{background:white; box-shadow:0 4px 20px rgba(2,6,23,0.06); position:sticky; top:0; z-index:40}
    .container{max-width:1100px; margin:0 auto; padding:20px}
    .nav {display:flex; align-items:center; justify-content:space-between; gap:12px}
    .logo {font-size:20px; font-weight:800; color:var(--accent)}
    .nav-right {display:flex; gap:10px; align-items:center}
    .btn {padding:8px 14px; border-radius:10px; font-weight:600; cursor:pointer; border:none}
    .btn-primary {background:var(--accent); color:white}
    .btn-ghost {background:transparent; color:var(--accent); border:1px solid rgba(6,182,212,0.12)}
    /* Hero */
    .hero {padding:56px 20px; border-radius:12px; background: linear-gradient(130deg,#0ea5e9 0%, #06b6d4 100%); color:white; display:flex; align-items:center; justify-content:space-between; gap:20px}
    .hero h1{font-size:46px; line-height:1; margin:0; font-weight:800}
    .hero p{margin:8px 0 0; color:rgba(255,255,255,0.9); font-weight:500}
    /* floating badges */
    .floating {display:flex; gap:12px}
    .badge {background:white; color:#0f172a; padding:8px 12px; border-radius:12px; font-weight:700; box-shadow:0 6px 18px rgba(2,6,23,0.06); transform-origin:center; animation:float 3.2s ease-in-out infinite}
    .badge:nth-child(2){animation-delay:0.25s} .badge:nth-child(3){animation-delay:0.5s}
    @keyframes float {0%{transform:translateY(0)}50%{transform:translateY(-14px)}100%{transform:translateY(0)}}

    /* products */
    .grid {display:grid; grid-template-columns: repeat(1,1fr); gap:18px; margin-top:28px}
    @media(min-width:640px){ .grid {grid-template-columns:repeat(2,1fr)} }
    @media(min-width:1024px){ .grid {grid-template-columns:repeat(3,1fr)} }
    .card {background:white; border-radius:12px; overflow:hidden; box-shadow:0 6px 18px rgba(2,6,23,0.06); transition:transform .15s ease, box-shadow .15s ease}
    .card:hover {transform:translateY(-6px); box-shadow:0 24px 48px rgba(2,6,23,0.08);}
    .card .img {height:180px; background:linear-gradient(90deg,#eef2ff,#f8fcff); display:flex; align-items:center; justify-content:center; color:#94a3b8}
    .card .body {padding:14px}
    .price {font-weight:800; color:var(--accent); font-size:18px}

    /* modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(2,6,23,0.45); display:flex; align-items:center; justify-content:center; z-index:60}
    .modal{background:white; border-radius:12px; width:min(720px,95%); padding:18px}

    footer{padding:28px 20px; color:var(--muted); font-size:14px}
    .muted{color:var(--muted)}
    /* small helpers */
    .hidden{display:none}
  </style>
</head>
<body class="min-h-screen">

  <!-- Header / Nav -->
  <header>
    <div class="container nav">
      <div class="left">
        <span class="logo">ğŸ’ ìœ„ë„ˆìŠ¤ (WeNers)</span>
      </div>
      <div class="nav-right">
        <nav class="muted" aria-label="main nav">
          <a href="#" onclick="scrollToSection('home');return false" class="muted">í™ˆ</a>
          <a href="#" onclick="scrollToSection('products');return false" class="muted" style="margin-left:12px">ìƒí’ˆ</a>
        </nav>
        <div style="width:12px"></div>
        <button id="btn-login" class="btn btn-ghost">ë¡œê·¸ì¸</button>
        <button id="btn-register" class="btn btn-ghost">íšŒì›ê°€ì…</button>
        <button id="btn-create" class="btn btn-primary">ìƒí’ˆë“±ë¡</button>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <main class="container" id="home">

    <!-- Hero / Main Banner -->
    <section class="hero" style="margin-top:18px; align-items:center;">
      <div style="flex:1;">
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="badge" style="background:rgba(255,255,255,0.12); color:white;">ğŸ”¥ ì˜¤ëŠ˜ ë“±ë¡ëœ ì‹ ê·œìƒí’ˆì´ <strong id="todayCount">0</strong>ê°œ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <h1>ì‘ì€ ê±°ë˜ë„ ì¦ê±°ìš´ ê²½ë§¤ë¡œ</h1>
        <p style="font-size:18px; margin-top:8px;">
          ìœ„ë„ˆìŠ¤ì—ì„œ <span id="slogan">íŒ”ë˜? ë§ë˜? <strong style="color:yellow">ì‚´ë˜? ë§ë˜?</strong></span>
        </p>
        <div style="margin-top:18px; display:flex; gap:12px;">
          <button class="btn btn-ghost" onclick="scrollToSection('products')">êµ¬ê²½í•˜ëŸ¬ ê°€ê¸°</button>
          <button class="btn btn-primary" id="hero-create">ìƒí’ˆ ë“±ë¡</button>
        </div>
      </div>

      <div style="width:320px; display:flex; flex-direction:column; align-items:flex-end;">
        <div class="floating">
          <div class="badge">Book</div>
          <div class="badge">Doll</div>
          <div class="badge">Living</div>
        </div>
      </div>
    </section>

    <!-- Products list -->
    <section id="products" style="margin-top:24px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0">ìƒí’ˆ ëª©ë¡</h2>
        <div class="muted">WeNers â€” Demo</div>
      </div>

      <div id="productList" class="grid">
        <!-- JS ë Œë”ë§ -->
      </div>

      <div id="emptyNotice" style="margin-top:22px; padding:14px; background:white; border-radius:8px; display:none; box-shadow:0 6px 18px rgba(2,6,23,0.04);">
        í˜„ì¬ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer>
    <div class="container">
      Â© WeNers â€” ì‘ì€ ê±°ë˜ë„ ì¦ê±°ìš´ ê²½ë§¤ Â· ë°ëª¨
    </div>
  </footer>

  <!-- Modal: Product detail / Bid -->
  <div id="modalBackdrop" class="hidden">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 id="modalTitle">ìƒí’ˆ ìƒì„¸</h3>
        <button onclick="closeModal()" class="btn">ë‹«ê¸°</button>
      </div>
      <div id="modalContent" style="margin-top:12px;">
        <!-- JS ì±„ì›€ -->
      </div>
    </div>
  </div>

  <!-- scripts -->
  <script type="module">
    /* -------------------------------------------------------------------
       Supabase init (ES module import)
       - config.js must define window.SUPABASE_URL and window.SUPABASE_ANON_KEY
       ------------------------------------------------------------------- */
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ì•ˆì „ ì²´í¬
    if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
      console.error("Supabase config missing (config.js). window.SUPABASE_URL / SUPABASE_ANON_KEY í•„ìš”");
    }

    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    window.supabaseClient = supabase;
    console.log("ğŸ”¥ Supabase ì—°ê²° ì„±ê³µ!");

    /* ---------------------------
       ê°„ë‹¨í•œ ì „ì—­ ìœ í‹¸ / DOM í—¬í¼
       --------------------------- */
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    // UI ìš”ì†Œ
    const productListEl = document.getElementById('productList');
    const emptyNotice = document.getElementById('emptyNotice');
    const todayCountEl = document.getElementById('todayCount');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContent = document.getElementById('modalContent');
    const modalTitle = document.getElementById('modalTitle');

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('btn-create').addEventListener('click', () => {
      location.href = './create.html'; // create í˜ì´ì§€ê°€ ìˆë‹¤ë©´ ì—°ê²° (ì—†ìœ¼ë©´ ì¶”í›„ ë§Œë“¤ ì˜ˆì •)
    });
    document.getElementById('hero-create').addEventListener('click', () => {
      location.href = './create.html';
    });
    document.getElementById('btn-login').addEventListener('click', () => {
      location.href = './auth_login.html';
    });
    document.getElementById('btn-register').addEventListener('click', () => {
      location.href = './auth_signup.html';
    });

    /* ---------------------------
       ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°: products í…Œì´ë¸”
       - ì»¬ëŸ¼: id, title, description, price_start, price_end, buy_now, images (json)
       --------------------------- */
    async function loadProducts() {
      productListEl.innerHTML = '';
      emptyNotice.style.display = 'none';
      try {
        const { data, error } = await supabase
          .from('products')
          .select('id, title, description, price_start, price_end, buy_now, images, created_at')
          .order('created_at', { ascending: false });

        if (error) {
          console.error("ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
          emptyNotice.style.display = 'block';
          emptyNotice.textContent = "ì„œë²„ì—ì„œ ìƒí’ˆ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        if (!data || data.length === 0) {
          emptyNotice.style.display = 'block';
          emptyNotice.textContent = "ë“±ë¡ëœ ìƒí’ˆì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.";
          todayCountEl.textContent = 0;
          return;
        }

        // ì˜¤ëŠ˜ ë“±ë¡ëœ ìƒí’ˆ ìˆ˜ (UTC ê¸°ì¤€)
        const today = new Date().toISOString().slice(0,10);
        const todayCount = data.filter(p => (p.created_at||'').slice(0,10) === today).length;
        todayCountEl.textContent = todayCount;

        renderProducts(data);
      } catch (err) {
        console.error(err);
        emptyNotice.style.display = 'block';
      }
    }

    /* ---------------------------
       ë Œë”ë§: ìƒí’ˆ ì¹´ë“œ
       --------------------------- */
    function renderProducts(list) {
      productListEl.innerHTML = '';
      list.forEach(p => {
        const div = document.createElement('div');
        div.className = 'card';

        // ì´ë¯¸ì§€ ì²˜ë¦¬: images ì¹¼ëŸ¼ì´ ë°°ì—´ì´ë©´ ì²« ì´ë¯¸ì§€ ì‚¬ìš©, ì—†ìœ¼ë©´ í”Œë ˆì´ìŠ¤í™€ë”
        const imgUrl = (p.images && p.images.length && p.images[0]) ? p.images[0] : null;
        div.innerHTML = `
          <div class="img">
            ${imgUrl ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(p.title)}" style="max-width:100%; max-height:100%; object-fit:cover;">`
                      : `<div style="text-align:center; padding:20px;"><svg width="64" height="64" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="#eef2ff"></rect><path d="M7 12h10" stroke="#c7d2fe" stroke-width="1.5" stroke-linecap="round"></path></svg></div>`}
          </div>
          <div class="body">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>${escapeHtml(p.title)}</strong>
              <div class="price">${formatPrice(p.price_start)}ì›</div>
            </div>
            <p style="margin:8px 0 0; color:#475569;">${escapeHtml(truncate(p.description||'',140))}</p>
            <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
              <button class="btn btn-ghost" onclick="openDetail('${p.id}')">ìƒì„¸ë³´ê¸°</button>
              <button class="btn btn-primary" onclick="placeBidPrompt('${p.id}')">ì…ì°°í•˜ê¸°</button>
            </div>
          </div>
        `;
        productListEl.appendChild(div);
      });
    }

    /* ---------------------------
       ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
       --------------------------- */
    async function openDetail(id) {
      try {
        const { data, error } = await supabase
          .from('products')
          .select('id, title, description, price_start, price_end, buy_now, images, created_at')
          .eq('id', id)
          .limit(1)
          .single();

        if (error) {
          console.error(error);
          alert('ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        modalTitle.textContent = data.title;
        modalContent.innerHTML = `
          <div style="display:flex; gap:12px; align-items:flex-start;">
            <div style="flex:1">
              ${data.images && data.images.length ? `<img src="${escapeHtml(data.images[0])}" style="width:100%; border-radius:8px;" />` : '<div class="img" style="height:200px">ì´ë¯¸ì§€ ì—†ìŒ</div>'}
            </div>
            <div style="width:320px">
              <div style="font-weight:700; font-size:18px; color:var(--accent); margin-bottom:8px">${formatPrice(data.price_start)}ì›</div>
              <div style="color:#374151; margin-bottom:12px;">${escapeHtml(data.description||'')}</div>
              <div style="display:flex; gap:8px;">
                <button class="btn btn-primary" onclick="placeBidPrompt('${data.id}')">ì…ì°°</button>
                <button class="btn btn-ghost" onclick="buyNow('${data.id}')">ì¦‰ì‹œêµ¬ë§¤</button>
              </div>
            </div>
          </div>
        `;

        modalBackdrop.classList.remove('hidden');
        modalBackdrop.style.display = 'flex';
      } catch (err) {
        console.error(err);
      }
    }

    function closeModal() {
      modalBackdrop.classList.add('hidden');
      modalBackdrop.style.display = 'none';
    }
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });

    /* ---------------------------
       ì…ì°° (ê°„ë‹¨í•œ í”„ë¡¬í”„íŠ¸)
       - bids í…Œì´ë¸”ì— insert (product_id, bidder, amount, created_at)
       - í˜„ì¬ëŠ” ë¡œê·¸ì¸ ì—°ë™ì´ ì—†ìœ¼ë©´ ìµëª…ì²˜ë¦¬
       --------------------------- */
    async function placeBidPrompt(productId) {
      const amountStr = prompt('ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì›)');
      if (!amountStr) return;
      const amount = Number(amountStr);
      if (isNaN(amount) || amount <= 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

      // bidder: ì´ë©”ì¼ì´ ìˆë‹¤ë©´ ë¶™ì´ê³ , ì—†ë‹¤ë©´ "guest"
      let bidder = 'guest';
      try {
        const user = await supabase.auth.getUser();
        if (user && user.data && user.data.user) {
          bidder = user.data.user.email || user.data.user.id || 'user';
        }
      } catch (e) { bidder = 'guest'; }

      // insert
      const { error } = await supabase
        .from('bids')
        .insert([{ product_id: productId, bidder, amount }]);

      if (error) {
        console.error('ì…ì°° ì‹¤íŒ¨:', error);
        alert('ì…ì°°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } else {
        alert('ì…ì°°ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // í•„ìš”í•˜ë©´ ì‹¤ì‹œê°„ ë°˜ì˜ ìœ„í•´ loadProducts();
      }
    }

    async function buyNow(productId) {
      // ì¦‰ì‹œêµ¬ë§¤ ì²˜ë¦¬ ë¡œì§ ì˜ˆì‹œ: ìƒí’ˆì— buy_now ê¸ˆì•¡ì´ ìˆìœ¼ë©´ bid í…Œì´ë¸”ì— ê¸°ë¡í•˜ê³  ìƒí’ˆ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê°„ë‹¨ ì˜ˆì‹œ)
      const confirmBuy = confirm('ì¦‰ì‹œêµ¬ë§¤ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
      if (!confirmBuy) return;
      const { data, error } = await supabase.from('products').select('buy_now').eq('id', productId).single();
      if (error) { alert('ì²˜ë¦¬ ì‹¤íŒ¨'); return; }
      const price = data.buy_now || 0;
      await supabase.from('bids').insert([{ product_id: productId, bidder: 'buyer', amount: price }]);
      alert('êµ¬ë§¤ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    /* ---------------------------
       ìœ í‹¸: escape / format
       --------------------------- */
    function escapeHtml(s='') {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'", '&#39;');
    }
    function truncate(s, n=140){ return s.length>n ? s.slice(0,n)+'...' : s; }
    function formatPrice(n){ if(n==null) return '0'; return Number(n).toLocaleString(); }

    /* ---------------------------
       í˜ì´ì§€ ìŠ¤í¬ë¡¤ í—¬í¼
       --------------------------- */
    function scrollToSection(id){
      const el = document.getElementById(id);
      if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
    }

    /* ---------------------------
       Realtime (ì„ íƒ) : products ë˜ëŠ” bids ë³€ê²½ ì‹œ ìë™ ê°±ì‹ 
       - Supabase Realtime ì‚¬ìš©: public í…Œì´ë¸”ì— RLS / Policy í—ˆìš© í•„ìš”
       --------------------------- */
    try {
      // Realtime ì±„ë„ êµ¬ë… (products í…Œì´ë¸” ë³€ê²½ ì‹œ)
      supabase.channel('public:products')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, payload => {
          console.log('Realtime products change:', payload);
          // ë³€ê²½ ë°œìƒí•˜ë©´ ì œí’ˆ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
          loadProducts();
        })
        .subscribe();
    } catch(e) {
      console.warn('Realtime setup error (í—ˆìš©ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì¼ ìˆ˜ ìˆìŒ):', e);
    }

    /* ---------------------------
       ì´ˆê¸° ì‹¤í–‰
       --------------------------- */
    document.addEventListener('DOMContentLoaded', () => {
      loadProducts();
      // ì›ë˜ì˜ ë©”ì¸ ìŠ¬ë¼ì´ë”/ì• ë‹ˆë©”ì´ì…˜ ë“±ì€ CSS/JSë¡œ êµ¬í˜„ â€” ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì˜ˆì‹œ
      rotateSlogan();
      setInterval(rotateSlogan, 4000);
    });

    const slogans = ['íŒ”ë˜? ë§ë˜? ì‚´ë˜? ë§ë˜?', 'ë†“ì¹˜ë©´ í›„íšŒí•  ì°¬ìŠ¤!', 'ë¯¿ê³  ê±°ë˜í•˜ëŠ” WeNers'];
    let sIdx = 0;
    function rotateSlogan(){
      sIdx = (sIdx+1) % slogans.length;
      const el = document.getElementById('slogan');
      if(el) el.textContent = slogans[sIdx];
    }

    /* -------------------------------------------------------------------
       ê°œë°œ/ë””ë²„ê·¸ ë³´ì¡°: ì½˜ì†”ì— ìš”ì•½ ìƒíƒœ ì¶œë ¥
       ------------------------------------------------------------------- */
    console.log('WeNers Demo UI ì´ˆê¸°í™” ì™„ë£Œ');
  </script>
</body>
</html>
