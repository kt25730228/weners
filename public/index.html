<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ìœ„ë„ˆìŠ¤ ê²½ë§¤ ë°ëª¨ (Fixed - All features v11 - Final Patched)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; }

  /* ë¶€ë“œëŸ¬ìš´ ë°˜ëŒ€ ê¹œë¹¡ì„ (ì›ë³¸ ìœ ì§€) */
  @keyframes fadeA {
    0%, 45% { opacity: 1; }
    55%, 100% { opacity: 0.15; }
  }
  @keyframes fadeB {
    0%, 45% { opacity: 0.15; }
    55%, 100% { opacity: 1; }
  }
  .fade-a { animation: fadeA 3s infinite ease-in-out; }
  .fade-b { animation: fadeB 3s infinite ease-in-out; }

  /* ë‘¥ë‘¥ ë– ë‹¤ë‹ˆëŠ” ì• ë‹ˆë©”ì´ì…˜ (ì›ë³¸ ìœ ì§€) */
  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
  }
  .animate-float { animation: float 4s ease-in-out infinite; }
  .animate-float-delay { animation: float 4s ease-in-out infinite; animation-delay: 2s; }

  /* ê¸´ ì œëª©ì„ ì•ˆì „í•˜ê²Œ 2ì¤„ê¹Œì§€ í‘œì‹œ (ì›ë³¸ì€ í•œ ì¤„ ì¶•ì†Œ ë°©ì‹ì´ì—ˆìŒ) */
  .shrink-text-container {
      overflow: hidden;
      display: block;
      width: 100%;
      line-height: 1.25rem;
      max-height: 2.5rem; /* 2 lines */
  }
  .shrink-text {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      font-size: 1.125rem;
      font-weight: 700;
  }

  /* ì ‘ê·¼ì„± focus outline */
  .focus-outline:focus { outline: 2px solid rgba(14,165,233,0.6); outline-offset: 2px; }

  /* ëª¨ë°”ì¼ì—ì„œ ì œëª© ì¶•ì†Œ ëŒ€ì‹  ì¤„ ë°”ê¿ˆ í—ˆìš© */
  @media (max-width: 640px) {
    .shrink-text { font-size: 1rem; }
  }
</style>
</head>
<body class="bg-sky-50 min-h-screen text-gray-800">
<div id="app" class="max-w-7xl mx-auto p-6"></div>

<script>
/* ==================================================
   ì•ˆì „ ìœ í‹¸ / DOM í—¬í¼
   - el(): ì•ˆì „í•œ DOM ìƒì„±, textContent ì‚½ì… ê¶Œì¥
   - escapeHtml(): ë””ë²„ê¹…ìš©(í•„ìš” ì‹œ)
   ================================================== */
const el = (tag, attr={}, children=[]) => {
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attr||{})){
    if(k.startsWith('on') && typeof v === 'function') e.addEventListener(k.slice(2), v);
    else if(k === 'class') e.className = v;
    else if(k === 'style' && typeof v === 'object') Object.assign(e.style, v);
    else e.setAttribute(k, String(v));
  }
  if(typeof children === 'string') e.textContent = children;
  else (children||[]).forEach(c => e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
  return e;
};
const escapeHtml = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* ê°„ë‹¨í•œ alert wrapper (ë°ëª¨ìš©) */
const toast = msg => { try { alert(msg); } catch(e) { console.log(msg); } };

/* ìˆ«ì/ì‹œê°„ format ìœ í‹¸ */
const formatNumber = num => num ? Number(num).toLocaleString() : '0';
const fmt = d => new Date(d).toLocaleString('ko-KR');
const fmtDate = d => new Date(d).toLocaleDateString('ko-KR');

/* debounce (ê²€ìƒ‰ ì…ë ¥ ë“±ì—ì„œ ì‚¬ìš©) */
function debounce(fn, wait=250){
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(()=> fn(...args), wait);
  };
}

/* ìˆ«ì ì…ë ¥ í¬ë§·íŒ… (ì²œë‹¨ìœ„ ì½¤ë§ˆ) */
const formatInput = (target) => {
    let val = target.value.replace(/[^0-9]/g, '');
    target.value = val ? parseInt(val).toLocaleString() : '';
};
const parseFormattedNumber = (str) => {
    if (typeof str !== 'string') return str;
    return parseInt(str.replace(/,/g, '')) || 0;
}

/* timeLeft í…ìŠ¤íŠ¸ (ê°„ë‹¨) */
const timeLeft = end => {
  const diff = new Date(end) - new Date();
  if(diff <= 0) return 'ê²½ë§¤ ì¢…ë£Œ';
  const d = Math.floor(diff/86400000);
  const h = Math.floor((diff%86400000)/3600000);
  const m = Math.floor((diff%3600000)/60000);
  const s = Math.floor((diff%60000)/1000);
  return d ? `${d}ì¼ ${h}ì‹œê°„ ë‚¨ìŒ` : `${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;
};

/* ==================================================
   ìƒíƒœ(State) ë° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬
   ê°œì„  í¬ì¸íŠ¸:
   - loadProducts()ëŠ” productsë¥¼ ë°˜í™˜í•˜ë„ë¡ ë³´ì¥
   - saveUsers/saveProducts í•¨ìˆ˜ ì¼ê´€í™”
   ================================================== */
let state = {
  view: 'main',
  session: null,
  products: [],
  filter: '',
  detail: null,
  timerId: null
};

const KEY_USERS = 'w_users';
const KEY_PRODUCTS = 'w_products';
const KEY_SESSION = 'w_session';

const loadUsers = () => JSON.parse(localStorage.getItem(KEY_USERS) || '[]');
const saveUsers = (u) => localStorage.setItem(KEY_USERS, JSON.stringify(u));

const loadProducts = () => {
  const arr = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || '[]');
  // íƒ€ì… ì •ë¦¬
  arr.forEach(p=>{
    p.startingPrice = Number(p.startingPrice || 0);
    if(p.buyNow) p.buyNow = Number(p.buyNow);
    if(p.eventRangeStart) p.eventRangeStart = Number(p.eventRangeStart);
    if(p.eventRangeEnd) p.eventRangeEnd = Number(p.eventRangeEnd);
    p.bids = p.bids || [];
  });
  state.products = arr;
  return state.products;
};
const saveProducts = () => localStorage.setItem(KEY_PRODUCTS, JSON.stringify(state.products));

const loadSession = () => {
  const s = localStorage.getItem(KEY_SESSION);
  state.session = s ? JSON.parse(s) : null;
  return state.session;
};
const saveSession = (s) => {
  state.session = s;
  if(s) localStorage.setItem(KEY_SESSION, JSON.stringify(s));
  else localStorage.removeItem(KEY_SESSION);
};

/* ==================================================
   ì´ˆê¸°í™”(ë°ëª¨ ë°ì´í„°) â€” Idempotent, ì¤‘ë³µ ë°©ì§€
   - saveUsersë¥¼ ì—¬ëŸ¬ë²ˆ í˜¸ì¶œí•˜ë˜ ì›ë³¸ ë¬¸ì œ ìˆ˜ì •
   ================================================== */
(function initDemoData(){
  const users = loadUsers();
  if(!users.length){
    const initUsers = [
      {name:'ë°ëª¨ê¹€',email:'demo@user.com',password:'demo',birth:'1990-01-01',phone:'010-1234-5678'},
      {name:'ê²½ë§¤ì™•',email:'winner@user.com',password:'1234',birth:'1995-05-05',phone:'010-9876-5432'},
      {name:'ìš´ì˜ì',email:'admin@winners.com',password:'1234',birth:'2000-01-01',phone:'010-0000-0000'}
    ];
    saveUsers(initUsers);
  }
  const prods = loadProducts();
  if(!prods || prods.length === 0){
    state.products = [
      {
        id:Date.now()-1000,
        title:'[ë‚´ê°€ íŒ ìƒí’ˆ] ì—ì–´íŒŸ í”„ë¡œ 2ì„¸ëŒ€ (ì§„í–‰ì¤‘)',
        description:'ê±°ì˜ ìƒˆê²ƒ',
        type:'general',
        startingPrice:180000,
        buyNow:250000,
        images:['https://placehold.co/400x400/e0f2fe/0284c7?text=My+Sale'],
        endDate:new Date(Date.now()+48*3600000).toISOString(),
        creator:'demo@user.com',
        bids:[
          {user:'winner@user.com', price: 190000, time: new Date(Date.now()-700000).toISOString()},
          {user:'other@user.com', price: 195000, time: new Date(Date.now()-600000).toISOString()}
        ],
        sold:false,
        eventRangeStart:null,
        eventRangeEnd:null,
        winningPrice: null
      },
      {
        id:Date.now()-2000,
        title:'[ë‚´ê°€ íŒ ìƒí’ˆ] ì´ë²¤íŠ¸ - ë‹¹ì²¨ ì™„ë£Œ ìƒí’ˆëª… ë§¤ìš° ê¸¸ê²Œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì´ ì œëª©ì´ í•œ ì¤„ì— ëª¨ë‘ ë³´ì´ë„ë¡ í•´ì£¼ì„¸ìš”. ê¸€ì”¨ê°€ ì‘ì•„ì ¸ë„ ê´œì°®ìŠµë‹ˆë‹¤.',
        description:'ë§Œì›ëŒ€ ë§ì¶”ê¸° ì„±ê³µ',
        type:'event',
        startingPrice:1000,
        buyNow:null,
        eventRangeStart:10000,
        eventRangeEnd:19999,
        images:['https://placehold.co/400x400/fbbf24/000000?text=Event+Sold'],
        endDate:new Date(Date.now()-3600000).toISOString(),
        creator:'demo@user.com',
        bids:[
          {user:'winner@user.com', price: 15000, time: new Date(Date.now()-5*3600000).toISOString()}
        ],
        sold:true,
        eventClosed: true,
        eventWinner: 'winner@user.com',
        winningPrice: 15000
      },
      {
        id:Date.now()-86400000,
        title:'[ë‚´ê°€ ì…ì°°] ìŠ¤íƒ€ë²…ìŠ¤ ê¸°í”„í‹°ì½˜ (ë§ˆê° ì„ë°•)',
        description:'ìœ íš¨ê¸°ê°„ ë„‰ë„‰',
        type:'general',
        startingPrice:40000,
        buyNow:null,
        images:['https://placehold.co/400x400/1e3932/ffffff?text=My+Bid'],
        endDate:new Date(Date.now()+2*3600000).toISOString(),
        creator:'admin@winners.com',
        bids:[
          {user:'admin@winners.com', price: 40000, time: new Date(Date.now()-10*60000).toISOString()},
          {user:'demo@user.com', price: 45000, time: new Date(Date.now()-5*60000).toISOString()}
        ],
        sold:false,
        eventRangeStart:null,
        eventRangeEnd:null,
        winningPrice: null
      },
      {
        id:Date.now()-5000,
        title:'[ì´ë²¤íŠ¸] ë§Œì›ëŒ€ ë§ì¶”ê¸° (ì§„í–‰ ì¤‘) - 24ì‹œê°„ ì…ì°° ì œí•œ í…ŒìŠ¤íŠ¸ìš©ì…ë‹ˆë‹¤.',
        description:'ë§Œì›ëŒ€ ì¤‘ í•˜ë‚˜ë¥¼ ë§ì¶°ë³´ì„¸ìš”!',
        type:'event',
        startingPrice:1000,
        buyNow:null,
        eventRangeStart:10000,
        eventRangeEnd:19999,
        images:['https://placehold.co/400x400/fbbf24/000000?text=Event+Live'],
        endDate:new Date(Date.now()+5*24*3600000).toISOString(),
        creator:'admin@winners.com',
        bids:[
          {user:'demo@user.com', price: 15000, time: new Date().toISOString()}
        ],
        sold:false,
        eventClosed: false,
        winningPrice: null
      }
    ];
    saveProducts();
  } else {
    state.products = prods;
  }
})();

/* ==================================================
   ì „ì—­ íƒ€ì´ë¨¸: ìƒì„¸ í˜ì´ì§€ íƒ€ì´ë¨¸ë¥¼ ìœ„í•œ ë‹¨ì¼ ì¸í„°ë²Œ
   (ì›ë³¸ì€ ìƒì„¸ë§ˆë‹¤ setInterval ìƒì„± â†’ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìœ„í—˜)
   ================================================== */
if(!window.__w_ticker){
  window.__w_ticker = setInterval(()=>{
    document.querySelectorAll('[data-enddate]').forEach(node=>{
      const d = node.getAttribute('data-enddate');
      const diff = new Date(d) - new Date();
      if(diff <= 0) node.textContent = 'ê²½ë§¤ ì¢…ë£Œ';
      else{
        const days = Math.floor(diff/86400000);
        const hours = Math.floor((diff%86400000)/3600000);
        const mins = Math.floor((diff%3600000)/60000);
        const secs = Math.floor((diff%60000)/1000);
        node.textContent = days ? `${days}ì¼ ${hours}ì‹œê°„ ë‚¨ìŒ` : `${hours}ì‹œê°„ ${mins}ë¶„ ${secs}ì´ˆ`;
      }
    });
  }, 1000);
}

/* ==================================================
   UI ë Œë”ë§ ê´€ë ¨ í•¨ìˆ˜ë“¤
   (ì›ë³¸ ë¼ˆëŒ€ ìœ ì§€í•˜ë˜ innerHTMLë¡œ ì‚¬ìš©ì ì…ë ¥ì„ ì§ì ‘ ì‚½ì…í•˜ë˜ ê³³ì„ DOM ì¡°í•©ìœ¼ë¡œ ë³€ê²½)
   ================================================== */
const root = document.getElementById('app');

function render(){
  // clear prior interval for detail (we use global ticker now)
  root.innerHTML = '';
  loadProducts(); // ìµœì‹ í™”
  root.appendChild(renderHeader());

  switch(state.view){
    case 'main': root.appendChild(mainView()); break;
    case 'login': root.appendChild(loginView()); break;
    case 'signup': root.appendChild(signupView()); break;
    case 'findId': root.appendChild(findIdView()); break;
    case 'findPw': root.appendChild(findPwView()); break;
    case 'list': root.appendChild(listView()); break;
    case 'create': root.appendChild(createView()); break;
    case 'detail': if(state.detail) root.appendChild(detailView(state.detail)); else root.appendChild(listView()); break;
    case 'myBids': root.appendChild(myBidsView()); break;
    case 'mySales': root.appendChild(mySalesView()); break;
    default: root.appendChild(mainView()); break;
  }

  // adjust dynamic text sizes (if any)
  setTimeout(adjustTextSizes, 0);
}

/* Header */
function renderHeader(){
  const header = el('header',{class:'bg-white shadow p-4 rounded flex justify-between items-center mb-6 flex-wrap gap-3'});
  const left = el('div',{class:'flex items-center gap-3'});
  const brand = el('div',{class:'text-2xl font-bold text-sky-600 cursor-pointer focus-outline', role:'button', tabindex:0}, 'ìœ„ë„ˆìŠ¤');
  brand.addEventListener('click', ()=>{ state.view='main'; render(); });
  left.appendChild(brand);
  left.appendChild(el('div',{class:'text-sm text-gray-500 hidden sm:block'}, 'ì‘ì€ ê±°ë˜ë„ ì¦ê±°ìš´ ê²½ë§¤'));
  header.appendChild(left);

  const nav = el('div',{class:'flex items-center gap-2 flex-wrap'});
  if(state.session){
    nav.appendChild(el('span',{class:'text-sm font-medium'}, state.session.name + 'ë‹˜'));
    nav.appendChild(el('button',{class:'px-3 py-1 border rounded text-sm', onclick:()=>{ saveSession(null); state.view='main'; render(); }}, 'ë¡œê·¸ì•„ì›ƒ'));
    nav.appendChild(el('button',{class:'px-3 py-1 border rounded text-sm', onclick:()=>{ state.view='myBids'; render(); }}, 'ë‚´ ì…ì°°'));
    nav.appendChild(el('button',{class:'px-3 py-1 border rounded text-sm', onclick:()=>{ state.view='mySales'; render(); }}, 'ë‚´ íŒë§¤'));
    nav.appendChild(el('button',{class:'px-3 py-1 bg-sky-500 text-white rounded text-sm', onclick:()=>{ state.view='create'; render(); }}, 'ìƒí’ˆë“±ë¡'));
  } else {
    nav.appendChild(el('button',{class:'px-3 py-1 border rounded text-sm', onclick:()=>{ state.view='login'; render(); }}, 'ë¡œê·¸ì¸'));
    nav.appendChild(el('button',{class:'px-3 py-1 border rounded text-sm', onclick:()=>{ state.view='signup'; render(); }}, 'íšŒì›ê°€ì…'));
  }
  header.appendChild(nav);
  return header;
}

/* ë©”ì¸ ë·° (íˆì–´ë¡œ) */
function mainView(){
  const container = el('div',{});
  const hero = el('section',{class:'relative bg-gradient-to-br from-sky-600 via-sky-500 to-cyan-400 text-white overflow-hidden rounded-2xl shadow-2xl'});
  const inner = el('div',{class:'relative max-w-7xl mx-auto px-8 py-16 flex flex-col md:flex-row items-center justify-between gap-10'});
  const left = el('div',{class:'text-center md:text-left z-10 flex-1'});

  left.appendChild(el('div',{class:'inline-block bg-white/20 backdrop-blur-sm px-4 py-1 rounded-full text-sm font-bold mb-6 border border-white/30'}, ['ğŸ”¥ ì˜¤ëŠ˜ ë“±ë¡ëœ ì‹ ê·œìƒí’ˆì´ ', el('span',{class:'text-yellow-300 text-lg'}, String(state.products.filter(p=>new Date(p.id).toDateString() === new Date().toDateString()).length)), 'ê°œ ìˆìŠµë‹ˆë‹¤.']));
  left.appendChild(el('h1',{class:'text-4xl md:text-6xl font-extrabold mb-6 leading-tight'}, 'ì‘ì€ ê±°ë˜ë„\nì¦ê±°ìš´ ê²½í—˜ìœ¼ë¡œ'));
  left.appendChild(el('p',{class:'text-xl md:text-2xl mb-10 text-sky-100 font-bold'}, [`ìœ„ë„ˆìŠ¤ì—ì„œ `, el('span',{class:'text-yellow-300 fade-a'}, 'íŒ”ë˜? ë§ë˜?'), ' ', el('span',{class:'text-yellow-300 fade-b'}, ' ì‚´ë˜? ë§ë˜?')]));

  const ctas = el('div',{class:'flex flex-col sm:flex-row gap-4 justify-center md:justify-start'});
  ctas.appendChild(el('button',{class:'px-8 py-4 bg-white text-sky-600 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-50 transition transform hover:scale-105', onclick:()=>{ state.view='list'; render(); }}, 'êµ¬ê²½í•˜ëŸ¬ ê°€ê¸°'));
  if(state.session) ctas.appendChild(el('button',{class:'px-8 py-4 bg-sky-700 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-sky-800 transition transform hover:scale-105', onclick:()=>{ state.view='create'; render(); }}, 'ìƒí’ˆ ë“±ë¡'));

  left.appendChild(ctas);
  inner.appendChild(left);

  // right visual (kept but non-essential)
  const right = el('div',{class:'flex-1 relative w-full max-w-lg h-96 hidden md:block'});
  right.appendChild(el('div',{class:'absolute top-0 right-10 w-40 h-40 bg-white p-2 rounded-2xl shadow-2xl animate-float rotate-3 z-20'}, [ el('img',{src:'https://placehold.co/300x300/e0f2fe/0284c7?text=Electronics', class:'w-full h-full object-cover rounded-xl', alt:'Electronics'}) , el('div',{class:'absolute -bottom-3 -right-3 bg-yellow-400 text-sky-900 text-xs font-bold px-2 py-1 rounded'}, 'HOT') ]));
  right.appendChild(el('div',{class:'absolute bottom-10 left-10 w-36 h-36 bg-white p-2 rounded-2xl shadow-2xl animate-float-delay -rotate-6 z-10'}, [ el('img',{src:'https://placehold.co/300x300/fce7f3/db2777?text=Doll', class:'w-full h-full object-cover rounded-xl', alt:'Doll'}) ]));
  right.appendChild(el('div',{class:'absolute top-20 left-20 w-32 h-32 bg-white p-2 rounded-2xl shadow-xl z-0'}, [ el('img',{src:'https://placehold.co/300x300/fff7ed/ea580c?text=Book', class:'w-full h-full object-cover rounded-xl', alt:'Book'}) ]));
  right.appendChild(el('div',{class:'absolute bottom-0 right-20 w-32 h-32 bg-white p-2 rounded-2xl shadow-xl z-0 rotate-12'}, [ el('img',{src:'https://placehold.co/300x300/f0fdf4/16a34a?text=Living', class:'w-full h-full object-cover rounded-xl', alt:'Living'}) ]));
  inner.appendChild(right);

  hero.appendChild(inner);
  container.appendChild(hero);
  return container;
}

/* idì°¾ê¸°/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°ëŠ” ë™ì¼ ë¡œì§ ìœ ì§€, innerHTML ì‚¬ìš© ì œê±° (ì•ˆì „) */
function findIdView(){
  const card = el('div',{class:'max-w-md mx-auto bg-white rounded-xl shadow p-8'});
  card.appendChild(el('h2',{class:'text-2xl font-bold text-sky-600 mb-6 text-center'}, 'ì•„ì´ë”” ì°¾ê¸°'));

  const form = el('form',{onsubmit:e=>{
    e.preventDefault();
    const name = e.target.name.value.trim();
    const y = e.target.y.value;
    const m = e.target.m.value.padStart(2,'0');
    const d = e.target.d.value.padStart(2,'0');
    const birth = `${y}-${m}-${d}`;
    const phone = e.target.phone.value;
    const user = loadUsers().find(u => u.name === name && u.birth === birth && u.phone === phone);
    if(!user) return toast('ì¼ì¹˜í•˜ëŠ” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
    toast(`íšŒì›ë‹˜ì˜ ì•„ì´ë””ëŠ”\n\n${user.email}\n\nì…ë‹ˆë‹¤`);
  }});

  form.appendChild(el('input',{name:'name',class:'w-full border rounded px-4 py-2 mb-4', placeholder:'ì„±ëª…', required:true}));
  const dateWrap = el('div',{class:'flex gap-2 mb-4'});
  dateWrap.appendChild(el('input',{name:'y',type:'text',maxlength:4,class:'w-1/2 border rounded px-4 py-2 text-center', placeholder:'ì¶œìƒì—°ë„(yyyy)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  dateWrap.appendChild(el('input',{name:'m',type:'text',maxlength:2,class:'w-1/4 border rounded px-4 py-2 text-center', placeholder:'ì›”(mm)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  dateWrap.appendChild(el('input',{name:'d',type:'text',maxlength:2,class:'w-1/4 border rounded px-4 py-2 text-center', placeholder:'ì¼(dd)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  form.appendChild(dateWrap);
  form.appendChild(el('input',{name:'phone',type:'text',maxlength:13,class:'w-full border rounded px-4 py-2 mb-6', placeholder:'íœ´ëŒ€í°ë²ˆí˜¸ (ìˆ«ìë§Œ ì…ë ¥)', required:true, oninput:e=>autoHyphen(e.target)}));
  form.appendChild(el('button',{class:'w-full bg-sky-500 text-white py-3 rounded font-bold'}, 'ì•„ì´ë”” ì°¾ê¸°'));
  card.appendChild(form);
  card.appendChild(el('p',{class:'text-center mt-4 text-sm'}, [ el('span',{class:'text-sky-600 cursor-pointer', onclick:()=>{ state.view='login'; render(); }}, 'â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°') ]));
  return card;
}

function findPwView(){
  const card = el('div',{class:'max-w-md mx-auto bg-white rounded-xl shadow p-8'});
  card.appendChild(el('h2',{class:'text-2xl font-bold text-sky-600 mb-6 text-center'}, 'ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°'));

  const form = el('form',{onsubmit:e=>{
    e.preventDefault();
    const email = e.target.email.value.trim();
    const y = e.target.y.value;
    const m = e.target.m.value.padStart(2,'0');
    const d = e.target.d.value.padStart(2,'0');
    const birth = `${y}-${m}-${d}`;
    const phone = e.target.phone.value;
    const users = loadUsers();
    const user = users.find(u => u.email === email && u.birth === birth && u.phone === phone);
    if(!user) return toast('ì¼ì¹˜í•˜ëŠ” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
    const temp = Math.random().toString(36).slice(-8);
    user.password = temp;
    saveUsers(users);
    toast(`ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰ ì™„ë£Œ!\n\n${temp}\n\në¡œê·¸ì¸ í›„ ê¼­ ë³€ê²½í•˜ì„¸ìš”`);
    state.view='login'; render();
  }});

  form.appendChild(el('input',{name:'email',class:'w-full border rounded px-4 py-2 mb-4', placeholder:'ì´ë©”ì¼', required:true}));
  const dateWrap = el('div',{class:'flex gap-2 mb-4'});
  dateWrap.appendChild(el('input',{name:'y',type:'text',maxlength:4,class:'w-1/2 border rounded px-4 py-2 text-center', placeholder:'ì¶œìƒì—°ë„(yyyy)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  dateWrap.appendChild(el('input',{name:'m',type:'text',maxlength:2,class:'w-1/4 border rounded px-4 py-2 text-center', placeholder:'ì›”(mm)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  dateWrap.appendChild(el('input',{name:'d',type:'text',maxlength:2,class:'w-1/4 border rounded px-4 py-2 text-center', placeholder:'ì¼(dd)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  form.appendChild(dateWrap);
  form.appendChild(el('input',{name:'phone',type:'text',maxlength:13,class:'w-full border rounded px-4 py-2 mb-6', placeholder:'íœ´ëŒ€í°ë²ˆí˜¸ (ìˆ«ìë§Œ ì…ë ¥)', required:true, oninput:e=>autoHyphen(e.target)}));
  form.appendChild(el('button',{class:'w-full bg-sky-500 text-white py-3 rounded font-bold'}, 'ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰'));
  card.appendChild(form);
  card.appendChild(el('p',{class:'text-center mt-4 text-sm'}, [ el('span',{class:'text-sky-600 cursor-pointer', onclick:()=>{ state.view='login'; render(); }}, 'â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°') ]));
  return card;
}

/* íšŒì›ê°€ì… ë·° (ì›ë³¸ íë¦„ ìœ ì§€, ì¤‘ë³µí™•ì¸ ë²„íŠ¼ì€ ë™ì‘ ìœ ì§€) */
function signupView(){
  const card = el('div',{class:'max-w-md mx-auto bg-white rounded-xl shadow p-8'});
  card.appendChild(el('h2',{class:'text-2xl font-bold text-sky-600 mb-6 text-center'}, 'íšŒì›ê°€ì…'));

  let emailOk = false;
  const form = el('form',{onsubmit:e=>{
    e.preventDefault();
    if(!emailOk) return toast('ì´ë©”ì¼ ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”');
    const name = e.target.name.value.trim();
    const email = e.target.email.value.trim();
    const birth = `${e.target.y.value}-${e.target.m.value.padStart(2,'0')}-${e.target.d.value.padStart(2,'0')}`;
    const phone = e.target.phone.value;
    const pw = e.target.password.value;
    const pwc = e.target.passwordc.value;
    if(pw !== pwc) return toast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
    if(!name || !email || !pw) return toast('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');

    const users = loadUsers();
    users.push({name, email, password:pw, birth, phone});
    saveUsers(users);
    toast('ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”');
    state.view='login'; render();
  }});

  form.appendChild(el('input',{name:'name',class:'w-full border rounded px-4 py-2 mb-3', placeholder:'ì„±ëª…', required:true}));
  const emailWrap = el('div',{class:'flex gap-2 mb-1'});
  const emailInput = el('input',{name:'email',id:'email',class:'flex-1 border rounded px-4 py-2', placeholder:'ì´ë©”ì¼', required:true});
  const dupBtn = el('button',{type:'button',class:'px-4 border rounded bg-gray-100 text-sm hover:bg-gray-200'}, 'ì¤‘ë³µí™•ì¸');
  emailWrap.appendChild(emailInput); emailWrap.appendChild(dupBtn);
  form.appendChild(emailWrap);
  const msg = el('p',{id:'dupMsg',class:'text-sm mb-3 min-h-6'});
  form.appendChild(msg);

  const dateWrap = el('div',{class:'flex gap-2 mb-3'});
  dateWrap.appendChild(el('input',{name:'y',type:'text',maxlength:4,class:'w-1/2 border rounded px-4 py-2 text-center', placeholder:'ì¶œìƒì—°ë„(yyyy)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  dateWrap.appendChild(el('input',{name:'m',type:'text',maxlength:2,class:'w-1/4 border rounded px-4 py-2 text-center', placeholder:'ì›”(mm)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  dateWrap.appendChild(el('input',{name:'d',type:'text',maxlength:2,class:'w-1/4 border rounded px-4 py-2 text-center', placeholder:'ì¼(dd)', required:true, oninput:e=>e.target.value=e.target.value.replace(/[^0-9]/g,'')}));
  form.appendChild(dateWrap);

  form.appendChild(el('input',{name:'phone',type:'text',maxlength:13,class:'w-full border rounded px-4 py-2 mb-3', placeholder:'íœ´ëŒ€í°ë²ˆí˜¸ (ìˆ«ìë§Œ ì…ë ¥)', required:true, oninput:e=>autoHyphen(e.target)}));

  form.appendChild(el('select',{name:'company',class:'w-full border rounded px-4 py-2 mb-3'}, [ el('option',{}, 'íšŒì‚¬ ì„ íƒ'), ...["ì›¹ì¼€ì‹œ","ì¿ ì½˜","ë¹„ì¦ˆí”Œë ˆì´","ë¹„í”Œí˜ì´"].map(c=> el('option',{}, c)) ]));
  form.appendChild(el('input',{name:'dept',class:'w-full border rounded px-4 py-2 mb-3', placeholder:'ì†Œì†ë¶€ì„œ'}));
  form.appendChild(el('input',{name:'password',type:'password',class:'w-full border rounded px-4 py-2 mb-3', placeholder:'ë¹„ë°€ë²ˆí˜¸', required:true}));
  form.appendChild(el('input',{name:'passwordc',type:'password',class:'w-full border rounded px-4 py-2 mb-6', placeholder:'ë¹„ë°€ë²ˆí˜¸ í™•ì¸', required:true}));
  form.appendChild(el('button',{class:'w-full bg-sky-500 text-white py-3 rounded font-bold'}, 'ê°€ì…í•˜ê¸°'));
  card.appendChild(form);
  card.appendChild(el('p',{class:'text-center mt-4 text-sm'}, 'ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”? ', el('span',{class:'text-sky-600 cursor-pointer', onclick:()=>{ state.view='login'; render(); }}, 'ë¡œê·¸ì¸')));

  // ì¤‘ë³µí™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸(ì•ˆì „)
  dupBtn.addEventListener('click', ()=>{
    const email = emailInput.value.trim();
    if(!email) return toast('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”');
    const ok = !loadUsers().some(u=>u.email===email);
    msg.textContent = ok ? 'ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤' : 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤';
    msg.style.color = ok ? 'green' : 'red';
    emailOk = ok;
  });

  return card;
}

/* ë¡œê·¸ì¸ ë·° */
function loginView(){
  const card = el('div',{class:'max-w-md mx-auto bg-white rounded-xl shadow p-8'});
  card.appendChild(el('h2',{class:'text-2xl font-bold text-sky-600 mb-6 text-center'}, 'ë¡œê·¸ì¸'));

  const form = el('form',{onsubmit:e=>{
    e.preventDefault();
    const email = e.target.email.value.trim();
    const pw = e.target.password.value;
    const user = loadUsers().find(u=>u.email===email && u.password===pw);
    if(!user) return toast('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤');
    saveSession({email:user.email, name:user.name});
    state.session = {email:user.email, name:user.name};
    state.view='list'; render();
  }});
  form.appendChild(el('input',{name:'email',class:'w-full border rounded px-4 py-2 mb-4', placeholder:'ì´ë©”ì¼', required:true}));
  form.appendChild(el('input',{name:'password',type:'password',class:'w-full border rounded px-4 py-2 mb-6', placeholder:'ë¹„ë°€ë²ˆí˜¸', required:true}));
  form.appendChild(el('button',{class:'w-full bg-sky-500 text-white py-3 rounded font-bold'}, 'ë¡œê·¸ì¸'));
  card.appendChild(form);
  card.appendChild(el('div',{class:'text-center mt-4 text-sm space-y-2'}, [
    el('div',{}, [ el('span',{class:'text-sky-600 cursor-pointer', onclick:()=>{ state.view='findId'; render(); }}, 'ì•„ì´ë”” ì°¾ê¸°'), ' | ', el('span',{class:'text-sky-600 cursor-pointer', onclick:()=>{ state.view='findPw'; render(); }}, 'ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°') ]),
    el('div',{}, ['ê³„ì •ì´ ì—†ë‚˜ìš”? ', el('span',{class:'text-sky-600 cursor-pointer', onclick:()=>{ state.view='signup'; render(); }}, 'íšŒì›ê°€ì…') ])
  ]));
  return card;
}

/* ìƒí’ˆ ë“±ë¡/ìˆ˜ì • (í†µí•© ë³µì› ë²„ì „) - createView í•¨ìˆ˜ ì•ˆì •í™” ë° ë¹ˆí™”ë©´ ë°©ì§€ */
function createView(product=null){
  const isEdit = !!product;
  if(isEdit) product = state.products.find(p=>p.id===product.id) || product;
  const isBidding = product?.bids?.length > 0;

  const card = el('div',{class:'max-w-4xl mx-auto bg-white rounded-xl shadow p-8'});
  card.appendChild(el('h2',{class:'text-3xl font-bold text-sky-600 mb-8 text-center'}, isEdit ? 'ìƒí’ˆ ìˆ˜ì •' : 'ìƒí’ˆ ë“±ë¡'));

  const defaultEndDate = product?.endDate ? product.endDate.substring(0,16) : new Date(Date.now() + 7*24*3600000).toISOString().substring(0,16);

  const form = el('form',{onsubmit: async e=>{
    e.preventDefault();
    const title = e.target.querySelector('#title')?.value.trim();
    const desc = e.target.querySelector('#description')?.value.trim();
    const type = e.target.querySelector('#auctionType')?.value;
    const endDateValue = e.target.querySelector('#endDateInput')?.value;
    const starting = parseFormattedNumber(e.target.querySelector('#startingPrice')?.value) || 0;
    const buyNow = parseFormattedNumber(e.target.querySelector('#buyNowInput')?.value || '') || null;
    const eventRangeStart = parseFormattedNumber(e.target.querySelector('#eventRangeStart')?.value || '') || null;
    const eventRangeEnd = parseFormattedNumber(e.target.querySelector('#eventRangeEnd')?.value || '') || null;
    const files = e.target.querySelector('#files')?.files || [];

    if(!title) return toast('ìƒí’ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if(!desc) return toast('ìƒí’ˆ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    if(starting <= 0) return toast('ì‹œì‘ê°€ëŠ” 0ì›ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
    if(!endDateValue) return toast('ê²½ë§¤ ì¢…ë£Œ ì¼ì‹œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');

    if(type === 'event'){
      if(!eventRangeStart || !eventRangeEnd) return toast('ì´ë²¤íŠ¸ ê²½ë§¤ì˜ ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      if(eventRangeStart >= eventRangeEnd) return toast('ì´ë²¤íŠ¸ ì¢…ë£Œê°€ëŠ” ì‹œì‘ê°€ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
    }

    const imgs = await uploadImg(files);

    if(isEdit){
      const p = state.products.find(item => item.id === product.id);
      if(!p) return toast('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      p.title = title; p.description = desc;
      if(!isBidding){
        p.type = type;
        p.startingPrice = starting;
        p.buyNow = type==='general' ? (buyNow || null) : null;
        p.eventRangeStart = type==='event' ? eventRangeStart : null;
        p.eventRangeEnd = type==='event' ? eventRangeEnd : null;
        p.endDate = new Date(endDateValue).toISOString();
      }
      if(imgs.length) p.images = imgs;
      saveProducts();
      toast('ìƒí’ˆ ìˆ˜ì • ì™„ë£Œ');
      state.view='detail'; state.detail = p; render();
      return;
    }

    const newProduct = {
      id: Date.now(),
      title, description: desc, type,
      startingPrice: starting,
      buyNow: type==='general' ? (buyNow || null) : null,
      eventRangeStart: type==='event' ? eventRangeStart : null,
      eventRangeEnd: type==='event' ? eventRangeEnd : null,
      images: imgs.length ? imgs : [`https://placehold.co/600x400/e0f2fe/0284c7?text=${encodeURIComponent(title)}`],
      endDate: new Date(endDateValue).toISOString(),
      creator: state.session?.email || 'anonymous',
      bids: [], sold:false, eventWinner:null, eventClosed:false
    };
    state.products.push(newProduct);
    saveProducts();
    toast('ìƒí’ˆ ë“±ë¡ ì™„ë£Œ');
    state.view='list'; render();
  }});

  // form fields (built via DOM to avoid injecting user input)
  form.appendChild(el('input',{id:'title',class:'w-full border rounded px-4 py-3 mb-4 text-lg', placeholder:'ìƒí’ˆ ì œëª©', value: product?.title || '', required:true}));
  form.appendChild(el('textarea',{id:'description',class:'w-full border rounded px-4 py-3 mb-6 h-40 text-lg', placeholder:'ìƒí’ˆ ì„¤ëª…ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”', required:true}, product?.description || ''));

  form.appendChild(el('div',{class:'bg-gray-100 p-4 rounded-lg mb-6'}, [ el('p',{class:'text-sm font-bold text-red-600 mb-2'}, 'ğŸ“¢ ê°€ê²©/ê²½ë§¤ ìœ í˜•/ì¢…ë£Œì¼ ë³€ê²½ ì•ˆë‚´'), el('p',{class:'text-xs text-gray-700'}, isBidding ? 'ì…ì°°ì´ ë°œìƒí•œ ìƒí’ˆì€ ê²½ë§¤ ìœ í˜•, ê°€ê²©, ì¢…ë£Œì¼ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'ëª¨ë“  í•­ëª© ìˆ˜ì • ê°€ëŠ¥') ]));

  const grid = el('div',{class:'grid grid-cols-1 md:grid-cols-2 gap-6 mb-6'});
  const leftCol = el('div',{}, []);
  leftCol.appendChild(el('label',{class:'block text-sm font-medium mb-2'}, 'ê²½ë§¤ ìœ í˜• *'));
  const auctionType = el('select',{id:'auctionType',class:'w-full border rounded px-4 py-3', required:true, onchange: e => toggleAuctionType(e.target.value), disabled:isBidding}, []);
  auctionType.appendChild(el('option',{value:'general'}, 'ì¼ë°˜ ê²½ë§¤'));
  auctionType.appendChild(el('option',{value:'event'}, 'ì´ë²¤íŠ¸ ê²½ë§¤'));
  if(product?.type === 'event') auctionType.value = 'event';
  leftCol.appendChild(auctionType);
  grid.appendChild(leftCol);

  const rightCol = el('div',{}, []);
  rightCol.appendChild(el('label',{class:'block text-sm font-medium mb-2'}, 'ì‹œì‘ê°€ (ìµœì†Œ ì…ì°° ê¸ˆì•¡) *'));
  rightCol.appendChild(el('input',{id:'startingPrice',class:'w-full border rounded px-4 py-3', placeholder:'ì˜ˆ: 10,000', value: formatNumber(product?.startingPrice), required:true, oninput: e=>formatInput(e.target), disabled:isBidding}));
  grid.appendChild(rightCol);
  form.appendChild(grid);

  form.appendChild(el('div',{class:'mb-6'}, [ el('label',{class:'block text-sm font-medium mb-2'}, 'ê²½ë§¤ ì¢…ë£Œ ì¼ì‹œ *'), el('input',{id:'endDateInput',type:'datetime-local',class:'w-full border rounded px-4 py-3', required:true, value: defaultEndDate, disabled:isBidding}), el('p',{class:'text-xs text-gray-500 mt-1'}, isBidding ? 'ê²½ë§¤ ì‹œì‘ í›„ ì¢…ë£Œì¼ì‹œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'ì¢…ë£Œ ì‹œê°ê¹Œì§€ ì •í™•íˆ ì„¤ì •í•´ ì£¼ì„¸ìš”.') ]));

  const generalFields = el('div',{id:'generalFields', class: product?.type === 'event' ? 'hidden' : ''}, []);
  generalFields.appendChild(el('label',{class:'block text-sm font-medium mb-2'}, 'ì¦‰ì‹œêµ¬ë§¤ê°€ (ì„ íƒ)'));
  generalFields.appendChild(el('input',{id:'buyNowInput',class:'w-full border rounded px-4 py-3 mb-6', placeholder:'ë¯¸ì…ë ¥ ì‹œ ì¦‰ì‹œêµ¬ë§¤ ë¶ˆê°€', value: formatNumber(product?.buyNow), oninput: e=>formatInput(e.target), disabled:isBidding}));
  form.appendChild(generalFields);

  const eventFields = el('div',{id:'eventFields', class: product?.type === 'event' ? '' : 'hidden bg-yellow-50 p-4 rounded-lg mb-6 border border-yellow-200'}, []);
  eventFields.appendChild(el('h3',{class:'text-lg font-bold text-yellow-800 mb-3'}, 'ì´ë²¤íŠ¸ ë‚™ì°° ë²”ìœ„ ì„¤ì •'));
  const evGrid = el('div',{class:'grid grid-cols-2 gap-4'});
  const evLeft = el('div',{}, [ el('label',{class:'block text-sm font-medium mb-2'}, 'ì´ë²¤íŠ¸ ì‹œì‘ê°€ (ìµœì†Œ ë‚™ì°° ì˜ˆìƒê°€) *'), el('input',{id:'eventRangeStart',class:'w-full border border-yellow-400 rounded px-4 py-3', placeholder:'ì˜ˆ: 10,000', value: formatNumber(product?.eventRangeStart), oninput: e=>formatInput(e.target), disabled:isBidding}) ]);
  const evRight = el('div',{}, [ el('label',{class:'block text-sm font-medium mb-2'}, 'ì´ë²¤íŠ¸ ì¢…ë£Œê°€ (ìµœëŒ€ ë‚™ì°° ì˜ˆìƒê°€) *'), el('input',{id:'eventRangeEnd',class:'w-full border border-yellow-400 rounded px-4 py-3', placeholder:'ì˜ˆ: 20,000', value: formatNumber(product?.eventRangeEnd), oninput: e=>formatInput(e.target), disabled:isBidding}) ]);
  evGrid.appendChild(evLeft); evGrid.appendChild(evRight);
  eventFields.appendChild(evGrid);
  eventFields.appendChild(el('p',{class:'text-xs text-gray-700 mt-2'}, 'ì…ì°°ìëŠ” [ì‹œì‘ê°€]ì™€ [ì¢…ë£Œê°€] ì‚¬ì´ì˜ ê¸ˆì•¡ë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¹ì²¨ ê¸ˆì•¡ì€ ë²”ìœ„ ë‚´ì—ì„œ ì¶”ì²¨ë©ë‹ˆë‹¤.'));
  form.appendChild(eventFields);

  form.appendChild(el('div',{class:'mb-8'}, [ el('label',{class:'block text-sm font-medium mb-3'}, 'ìƒí’ˆ ì‚¬ì§„ (ìµœëŒ€ 3ì¥, ìˆ˜ì • ì‹œ ê¸°ì¡´ ì´ë¯¸ì§€ ëŒ€ì²´)'), el('input',{id:'files',type:'file',accept:'image/*',multiple:true,class:'w-full border rounded px-4 py-3'}) ]));

  form.appendChild(el('button',{class:'w-full bg-sky-600 hover:bg-sky-700 text-white font-bold text-xl py-5 rounded-xl transition'}, isEdit ? 'ìƒí’ˆ ìˆ˜ì • ì™„ë£Œ' : 'ìƒí’ˆ ë“±ë¡í•˜ê¸°'));
  card.appendChild(form);
  // Ensure boolean attributes like 'disabled' are set correctly on actual DOM elements.
  // (el() previously set attributes via setAttribute which ended up setting disabled="false" and causing inputs to be disabled)
  setTimeout(()=>{
    const ids = ['auctionType','startingPrice','endDateInput','buyNowInput','eventRangeStart','eventRangeEnd','files'];
    ids.forEach(id => {
      const eln = form.querySelector('#' + id);
      if(!eln) return;
      // Set the DOM property based on isBidding (only disable when true)
      if(id === 'auctionType' || id === 'startingPrice' || id === 'endDateInput' || id === 'buyNowInput' || id === 'eventRangeStart' || id === 'eventRangeEnd') {
        eln.disabled = !!isBidding;
      }
    });
    // Also ensure the correct visibility for auction type sections
    const sel = form.querySelector('#auctionType');
    if(sel) toggleAuctionType(sel.value || 'general');
  }, 0);


  // toggle function
  window.toggleAuctionType = (type) => {
    const general = document.getElementById('generalFields');
    const event = document.getElementById('eventFields');
    const buyNow = document.getElementById('buyNowInput');
    const eventStart = document.getElementById('eventRangeStart');
    const eventEnd = document.getElementById('eventRangeEnd');

    if (!general || !event) return;

    if(type === 'event'){
        general.classList.add('hidden');
        event.classList.remove('hidden');

        if(eventStart) eventStart.required = true;
        if(eventEnd) eventEnd.required = true;
    } else {
        general.classList.remove('hidden');
        event.classList.add('hidden');

        if(eventStart) eventStart.required = false;
        if(eventEnd) eventEnd.required = false;
    }
};
  // initialize select
  const auctionTypeSel = form.querySelector('#auctionType');
  auctionTypeSel.value = product?.type || 'general';
  setTimeout(() => toggleAuctionType(auctionTypeSel.value), 0);

  return card;

}
/* ìƒí’ˆ ëª©ë¡ view */
function listView(){
  const wrap = el('div',{});
  wrap.appendChild(el('h2',{class:'text-3xl font-bold text-sky-600 mb-8'}, 'ìƒí’ˆ ëª©ë¡'));
  const search = el('input',{class:'w-full border rounded px-6 py-4 mb-8 text-lg', placeholder:'ìƒí’ˆ ê²€ìƒ‰', value:state.filter});
  search.addEventListener('input', debounce(e=>{ state.filter = e.target.value; render(); }, 200));
  wrap.appendChild(search);

  const grid = el('div',{class:'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8'});
  loadProducts().filter(p=>p.title.toLowerCase().includes(state.filter.toLowerCase())).forEach(p=>{
    const current = p.bids?.length ? p.bids[p.bids.length-1].price : p.startingPrice;
    const thumb = p.images?.[0] || `https://placehold.co/400x300/e0f2fe/0284c7?text=${encodeURIComponent(p.title)}`;
    const itemCard = el('div',{class:'bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer hover:shadow-2xl transition transform hover:-translate-y-2 p-4', role:'button', tabindex:0, onclick:()=>{ state.detail = p; state.view='detail'; render(); }});
    itemCard.appendChild(el('img',{src:thumb, class:'w-full h-64 object-cover bg-gray-50 rounded-md', loading:'lazy', alt:p.title}))
    // Badge row: NEW / ë§ˆê°ì„ë°• / ì´ë²¤íŠ¸ badges
    const badgeRow = el('div',{class:'flex items-center space-x-2 mt-3'});
    // New badge: created within 24 hours
    const createdAt = new Date(p.createdAt || p.id); // fallback to id timestamp
    const ageHours = (Date.now() - new Date(createdAt).getTime()) / 36e5;
    if(ageHours <= 24) {
      badgeRow.appendChild(el('span',{class:'text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-semibold'}, 'NEW'));
    }
    // Ending soon badge: within 24 hours
    const remaining = new Date(p.endDate).getTime() - Date.now();
    if(remaining > 0 && remaining <= 24*3600*1000){
      badgeRow.appendChild(el('span',{class:'text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-semibold'}, 'ë§ˆê°ì„ë°•'));
    }
    // Event badge
    if(p.type === 'event'){
      badgeRow.appendChild(el('span',{class:'text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-semibold'}, 'ì´ë²¤íŠ¸'));
    }
    itemCard.appendChild(badgeRow);
;
    itemCard.appendChild(el('div',{class:'mt-3 shrink-text-container', title:p.title}, [ el('div',{class:'shrink-text'}, p.title) ]));
    itemCard.appendChild(el('div',{class:'text-2xl font-bold text-sky-600 mt-2'}, formatNumber(current) + 'ì›'));
    itemCard.appendChild(el('div',{class:'text-sm text-gray-500 mt-2'}, 'ì…ì°° ' + (p.bids?.length||0) + ' Â· ë§ˆê° ' + fmt(p.endDate)));
    grid.appendChild(itemCard);
  });
  wrap.appendChild(grid);
  return wrap;
}

/* ìƒì„¸ view (ì›ë³¸ ê¸°ëŠ¥ ìœ ì§€) */
function detailView(p){
  // ensure fresh reference
  p = state.products.find(x=>x.id===p.id) || p;
  const currentPrice = p.bids?.length ? p.bids[p.bids.length-1].price : p.startingPrice;
  const isCreator = p.creator === state.session?.email;
  const isEnded = new Date(p.endDate) < new Date();
  const userName = state.session?.email;

  // ì´ë²¤íŠ¸ ê²½ë§¤ ë§ˆê° ì²˜ë¦¬(í´ë¼ì´ì–¸íŠ¸ ì‹œë®¬ë ˆì´ì…˜; ì‹¤ì œëŠ” ì„œë²„ ì²˜ë¦¬ í•„ìš”)
  if(p.type === 'event' && isEnded && !p.eventClosed){
    const start = p.eventRangeStart, end = p.eventRangeEnd;
    const validBids = p.bids.filter(b => b.price >= start && b.price <= end);
    if(validBids.length > 0){
      const randomIndex = Math.floor(Math.random() * validBids.length);
      const winnerBid = validBids[randomIndex];
      p.eventWinner = winnerBid.user;
      p.sold = true;
      p.winningPrice = winnerBid.price;
    }
    p.eventClosed = true;
    saveProducts();
  }

  // ì¼ë°˜ ê²½ë§¤ ë‹¹ì²¨ ì²˜ë¦¬
  if(p.type === 'general' && isEnded && !p.sold){
    if(p.bids.length > 0){
      p.winner = p.bids[p.bids.length-1].user;
      p.sold = true;
      p.winningPrice = currentPrice;
      saveProducts();
    }
  }

  // event í•˜ë£¨ ì…ì°° í™•ì¸
  const isEventBidToday = p.type === 'event' && p.bids.some(b => b.user === userName && fmtDate(b.time) === fmtDate(new Date()));
  const winnerEmail = p.type === 'event' ? p.eventWinner : p.winner;
  const winnerName = winnerEmail ? getUserName(winnerEmail) : null;
  const isWinner = winnerEmail === userName;

  const container = el('div',{class:'max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden p-6'});
  const grid = el('div',{class:'grid md:grid-cols-2 gap-8 p-8'});

  // left: images
  const left = el('div',{});
  const mainImg = el('img',{src:p.images?.[0] || 'https://placehold.co/600x400', id:'mainImg', class:'w-full h-96 object-contain bg-gray-50 rounded'});
  left.appendChild(mainImg);
  if(p.images?.length > 1){
    const thumbs = el('div',{class:'flex gap-3 mt-4 flex-wrap'});
    p.images.forEach((img,i)=> {
      const t = el('img',{src:img,class:`w-24 h-24 object-cover rounded cursor-pointer border-2 ${i===0 ? 'border-sky-500' : 'border-gray-300'}`, alt:'thumb', loading:'lazy'});
      t.addEventListener('click', ()=> document.getElementById('mainImg').src = img);
      thumbs.appendChild(t);
    });
    left.appendChild(thumbs);
  }
  grid.appendChild(left);

  // right: info + bid UI
  const right = el('div',{});
  right.appendChild(el('h1',{class:'text-4xl font-bold mb-4'}, p.title));
  right.appendChild(el('p',{class:'text-gray-600 mb-6 leading-relaxed whitespace-pre-line'}, p.description || 'ì„¤ëª… ì—†ìŒ'));

  // price display
  const priceDisplay = el('div',{class:'grid grid-cols-3 gap-4 mb-8'});
  priceDisplay.appendChild(el('div',{class:'bg-gray-100 p-3 rounded-lg border border-gray-200'}, [ el('div',{class:'text-sm text-gray-600 font-medium'}, 'ì‹œì‘ê°€'), el('div',{class:'text-lg font-bold text-gray-800'}, formatNumber(p.startingPrice) + 'ì›') ]));
  if(p.type==='general' && p.buyNow){
    priceDisplay.appendChild(el('div',{class:'bg-blue-100 p-3 rounded-lg border border-blue-300'}, [ el('div',{class:'text-sm text-blue-800 font-medium'}, 'ì¦‰ì‹œêµ¬ë§¤ê°€'), el('div',{class:'text-lg font-bold text-blue-900'}, formatNumber(p.buyNow)+'ì›') ]));
  } else if(p.type === 'event'){
    priceDisplay.appendChild(el('div',{class:'bg-yellow-100 p-3 rounded-lg border border-yellow-300'}, [ el('div',{class:'text-sm text-yellow-800 font-medium'}, 'ì…ì°° ë²”ìœ„'), el('div',{class:'text-lg font-bold text-yellow-900'}, formatNumber(p.eventRangeStart) + 'ì› ~ ' + formatNumber(p.eventRangeEnd) + 'ì›') ]));
  } else {
    priceDisplay.appendChild(el('div',{class:'bg-gray-100 p-3 rounded-lg border border-gray-200'}, [ el('div',{class:'text-sm text-gray-600 font-medium'}, 'ì¦‰ì‹œêµ¬ë§¤'), el('div',{class:'text-lg font-bold text-gray-400'}, 'ì—†ìŒ') ]));
  }
  priceDisplay.appendChild(el('div',{class:'bg-sky-100 p-3 rounded-lg border border-sky-300'}, [ el('div',{class:'text-sm text-sky-800 font-medium'}, p.type==='event' ? 'ìµœê³  ì…ì°°ê°€' : 'í˜„ì¬ ì…ì°°ê°€'), el('div',{class:'text-2xl font-extrabold text-sky-900'}, formatNumber(currentPrice) + 'ì›') ]));
  right.appendChild(priceDisplay);

  // timer
  right.appendChild(el('div',{class:'text-xl mb-6', id:'timer', 'data-enddate':p.endDate}, ''));

  // status message (ë‚™ì°°/ìœ ì°° ì•ˆë‚´)
  if(isEnded){
    if(p.sold){
      const price = p.winningPrice || currentPrice;
      const msgWrap = el('div',{class:'text-center bg-green-100 p-6 rounded-xl border-2 border-green-500 mb-8'});
      msgWrap.appendChild(el('div',{class:'text-3xl font-bold text-green-600 mb-3'}, isWinner ? `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${p.type === 'general' ? 'ë‚™ì°°' : 'ë‹¹ì²¨'}ë˜ì…¨ìŠµë‹ˆë‹¤.` : `${p.type === 'general' ? 'ë‚™ì°°' : 'ë‹¹ì²¨'} ì¢…ë£Œ: ${winnerName}ë‹˜ ${p.type === 'general' ? 'ë‚™ì°°' : 'ë‹¹ì²¨'}`));
      if(isWinner){
        const info = el('div',{class:'mt-4 text-left text-gray-700 space-y-2 text-sm'});
        info.appendChild(el('p',{}, 'ìµœì¢… ê¸ˆì•¡: ' + formatNumber(price) + 'ì›'));
        info.appendChild(el('p',{}, 'ì œí’ˆ ìˆ˜ë ¹ ì•ˆë‚´: ê²½ë§¤ë¬¼í’ˆ ì „ë‹¬ ë° ì§€ë¶ˆ ë°©ì‹ì€ ìœ„ì¹´í˜ì—ì„œ ì§ê±°ë˜ë¡œ ì´ë£¨ì–´ì§€ë©°, ìì„¸í•œ ì •ë³´ëŠ” íŒë§¤ìê°€ ì±„íŒ…ìœ¼ë¡œ ì•ˆë‚´ ì˜ˆì •ì…ë‹ˆë‹¤.'));
        msgWrap.appendChild(info);
      }
      right.appendChild(msgWrap);
    } else {
      right.appendChild(el('div',{class:'text-4xl font-bold text-red-600 mb-8 text-center'}, 'ê²½ë§¤ ì¢…ë£Œ (ìœ ì°°)'));
    }
  }

  // ì…ì°° UI (ì§„í–‰ì¤‘ì¼ ë•Œë§Œ)
  if(!isEnded && !p.sold){
    if(!state.session){
      right.appendChild(el('div',{class:'text-xl text-gray-500 mb-8'}, 'ë¡œê·¸ì¸ í›„ ì…ì°° ê°€ëŠ¥í•©ë‹ˆë‹¤.'));
    } else if(isCreator){
      right.appendChild(el('div',{class:'bg-gray-100 p-4 rounded text-center text-xl text-gray-500 mb-8'}, 'ë‚´ê°€ ì˜¬ë¦° ìƒí’ˆì…ë‹ˆë‹¤.'));
    } else if(p.type === 'event' && isEventBidToday){
      right.appendChild(el('div',{class:'bg-red-100 p-4 rounded text-center text-xl text-red-600 font-bold mb-8'}, 'ì˜¤ëŠ˜ì€ ì´ë¯¸ ì…ì°°í•˜ì…¨ìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”!'));
    } else {
      const amtInput = el('input',{type:'text',id:'bidAmount',class:'w-full border-2 border-sky-500 rounded-xl px-6 py-5 text-2xl text-center mb-4', placeholder: p.type==='event' ? `${formatNumber(p.eventRangeStart)} ~ ${formatNumber(p.eventRangeEnd)}` : formatNumber(currentPrice + 1000)});
      amtInput.addEventListener('input', (e)=>{ e.target.value = e.target.value.replace(/[^0-9]/g,'').replace(/\B(?=(\d{3})+(?!\d))/g, ','); });
      right.appendChild(amtInput);
      const bidBtn = el('button',{class:'w-full bg-sky-600 hover:bg-sky-700 text-white font-bold text-2xl py-6 rounded-xl transition mb-3', onclick:()=> placeBid(p.id) }, p.type==='event' ? 'ì´ë²¤íŠ¸ ì…ì°° (ì˜¤ëŠ˜ 1íšŒ ê°€ëŠ¥)' : 'ì…ì°°í•˜ê¸°');
      right.appendChild(bidBtn);
      if(p.type === 'general' && p.buyNow){
        right.appendChild(el('button',{class:'w-full bg-red-600 hover:bg-red-700 text-white font-bold text-2xl py-6 rounded-xl transition', onclick:()=> handleBuyNow(p.id)}, 'ì¦‰ì‹œêµ¬ë§¤ ' + formatNumber(p.buyNow) + 'ì›'));
      }
    }
  }

  // ì…ì°° ë‚´ì—­
  const bidsSection = el('div',{class:'mt-10'});
  bidsSection.appendChild(el('h3',{class:'text-2xl font-bold mb-4'}, 'ì…ì°° ë‚´ì—­'));
  const bidsList = el('div',{class:'space-y-3 max-h-96 overflow-y-auto'});
  if(p.bids && p.bids.length){
    p.bids.slice().reverse().forEach(b=>{
      const row = el('div',{class:'flex justify-between p-4 bg-gray-50 rounded-xl'}, []);
      const leftName = el('div',{}, getMaskedName(b.user) + (b.user === state.session?.email ? ' ' : ''));
      if(b.user === state.session?.email) leftName.appendChild(el('span',{class:'text-sky-600 text-xs font-bold'}, ' (ë‚˜)'));
      const rightInfo = el('div',{class:'text-right'}, [ el('div',{class:'font-bold text-sky-600'}, formatNumber(b.price) + 'ì›'), el('div',{class:'text-sm text-gray-500'}, fmt(b.time)) ]);
      row.appendChild(leftName); row.appendChild(rightInfo);
      bidsList.appendChild(row);
    });
  } else {
    bidsList.appendChild(el('p',{class:'text-center text-gray-500 py-8'}, 'ì•„ì§ ì…ì°°ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ì…ì°°ìê°€ ë˜ì–´ë³´ì„¸ìš”!'));
  }
  bidsSection.appendChild(bidsList);

  grid.appendChild(right);
  container.appendChild(grid);
  container.appendChild(bidsSection);
  return container;
}

/* ë‚´ì…ì°° */
function myBidsView(){
  const wrap = el('div',{});
  const myBidProducts = state.products.filter(p => p.bids.some(b => b.user === state.session?.email));
  wrap.appendChild(el('h2',{class:'text-3xl font-bold text-sky-600 mb-8'}, 'ë‚´ ì…ì°° ë‚´ì—­'));
  if(myBidProducts.length === 0){
    wrap.appendChild(el('p',{class:'text-center text-gray-500 py-10 bg-white rounded-xl shadow'}, 'ì•„ì§ ì…ì°°í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.'));
    return wrap;
  }
  const grid = el('div',{class:'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6'});
  myBidProducts.forEach(p=>{
    const myBids = p.bids.filter(b=>b.user===state.session.email);
    const myLastBid = myBids[myBids.length-1];
    const current = p.bids[p.bids.length-1].price;
    let statusBadge = '';
    let borderColor = 'border-gray-300';
    const isEnded = new Date(p.endDate) < new Date();

    if(p.type === 'event'){
      if(isEnded){
        if(p.eventWinner === state.session.email){
          statusBadge = 'ğŸ‰ ë‹¹ì²¨';
          borderColor = 'border-green-500';
        } else {
          statusBadge = 'âŒ ë‚™ì²¨';
          borderColor = 'border-red-500';
        }
      } else {
        statusBadge = `ì…ì°° ${myBids.length}íšŒ`;
        borderColor = 'border-blue-500';
      }
    } else {
      if(isEnded){
        if(p.winner === state.session.email){
          statusBadge = 'ğŸ‰ ë‚™ì°°';
          borderColor = 'border-green-500';
        } else {
          statusBadge = 'âŒ ìœ ì°°';
          borderColor = 'border-red-500';
        }
      } else {
        const isWinning = myLastBid.price === current;
        statusBadge = isWinning ? 'í˜„ì¬ ìµœê³ ê°€!' : 'ì…ì°° ë°€ë¦¼';
        borderColor = isWinning ? 'border-green-300' : 'border-red-300';
      }
    }

    const item = el('div',{class:`bg-white rounded-xl shadow p-6 border-l-4 ${borderColor} cursor-pointer`, onclick:()=>{ state.detail=p; state.view='detail'; render(); }}, []);
    item.appendChild(el('div',{class:'font-bold text-lg mb-2 truncate'}, p.title));
    const content = el('div',{class:'flex justify-between items-center'});
    const left = el('div',{}, [ el('div',{class:'text-sm text-gray-500'}, 'ë‚´ ìµœì¢… ì…ì°°ê°€'), el('div',{class:'font-bold text-xl'}, formatNumber(myLastBid.price) + 'ì›') ]);
    const right = el('div',{class:'text-right space-y-1'}, [ el('div',{}, statusBadge), el('div',{class:'text-sm text-gray-400'}, 'í˜„ì¬ê°€ ' + formatNumber(current) + 'ì›') ]);
    content.appendChild(left); content.appendChild(right);
    item.appendChild(content);
    grid.appendChild(item);
  });
  wrap.appendChild(grid);
  return wrap;
}

/* ë‚´íŒë§¤ */
function mySalesView(){
  const wrap = el('div',{});
  const myProducts = state.products.filter(p => p.creator === state.session?.email);
  wrap.appendChild(el('h2',{class:'text-3xl font-bold text-sky-600 mb-8'}, 'ë‚´ íŒë§¤ ê´€ë¦¬'));
  if(myProducts.length === 0){
    wrap.appendChild(el('p',{class:'text-center text-gray-500 py-10 bg-white rounded-xl shadow'}, 'ë“±ë¡í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!'));
    return wrap;
  }

  const list = el('div',{class:'space-y-4'});
  list.appendChild(el('div',{class:'hidden sm:grid grid-cols-7 gap-4 text-sm font-bold text-gray-600 p-4 bg-gray-200 rounded-t-xl'}, [ 
    el('div',{}, 'ìƒí’ˆ ì •ë³´'),
    el('div',{}, 'ê²½ë§¤ ìœ í˜•'),
    el('div',{}, 'ì‹œì‘ê°€'),
    el('div',{}, 'í˜„ì¬ ì…ì°°ê°€'),
    el('div',{}, 'ë‚™ì°°ê°€'),
    el('div',{}, 'ìƒíƒœ / ê´€ë¦¬')
  ]));

  myProducts.forEach(p=>{
    const currentPrice = p.bids.length ? p.bids[p.bids.length-1].price : p.startingPrice;
    const winningPrice = p.sold && p.winningPrice ? formatNumber(p.winningPrice)+'ì›' : '-';
    let status = '';
    const isEnded = new Date(p.endDate) < new Date();
    const isBidding = p.bids.length > 0;
    const auctionTypeLabel = p.type === 'event' ? 'ì´ë²¤íŠ¸' : 'ì¼ë°˜';

    if(isEnded){
      if(p.sold) status = el('span',{class:'bg-green-500 text-white px-2 py-1 rounded text-xs font-bold'}, p.type === 'event' ? 'ë‹¹ì²¨ ì™„ë£Œ' : 'ë‚™ì°° ì™„ë£Œ');
      else status = el('span',{class:'bg-red-500 text-white px-2 py-1 rounded text-xs font-bold'}, 'ìœ ì°°');
    } else {
      status = el('span',{class:'text-gray-500 text-sm'}, timeLeft(p.endDate));
    }

    const actions = el('div',{class:'flex gap-2 justify-end'});
    actions.appendChild(el('button',{class:'text-blue-500 text-sm hover:underline', onclick:e=>{ e.stopPropagation(); state.detail=p; state.view='edit'; render(); }}, 'ìˆ˜ì •'));
    if(!isBidding) actions.appendChild(el('button',{class:'text-red-500 text-sm hover:underline', onclick:e=>{ e.stopPropagation(); deleteProduct(p.id); }}, 'ì‚­ì œ'));
    else actions.appendChild(el('span',{class:'text-gray-400 text-sm'}, 'ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€'));

    const itemDiv = el('div',{class:'bg-white rounded-xl shadow p-4 flex flex-col sm:grid sm:grid-cols-7 gap-4 items-center cursor-pointer hover:bg-gray-50', onclick:()=>{ state.detail=p; state.view='detail'; render(); }});
    // ìƒí’ˆ ì •ë³´
    const info = el('div',{class:'col-span-2 flex items-center gap-3 w-full'});
    info.appendChild(el('img',{src:p.images?.[0]||'https://placehold.co/100', class:'w-16 h-16 rounded object-cover', alt:p.title, loading:'lazy'}));
    const infoText = el('div',{class:'truncate flex-1'}, []);
    infoText.appendChild(el('div',{class:'font-bold text-base truncate'}, p.title));
    infoText.appendChild(el('div',{class:'text-xs text-gray-500'}, 'ì…ì°° ' + p.bids.length + 'ê±´'));
    info.appendChild(infoText);
    itemDiv.appendChild(info);
    itemDiv.appendChild(el('div',{class:'text-right sm:text-center w-full sm:w-auto text-sm font-medium border-t sm:border-t-0 pt-2 sm:pt-0'}, auctionTypeLabel));
    itemDiv.appendChild(el('div',{class:'text-right w-full sm:w-auto text-sm border-t sm:border-t-0 pt-2 sm:pt-0'}, formatNumber(p.startingPrice)+'ì›'));
    itemDiv.appendChild(el('div',{class:'text-right w-full sm:w-auto text-sm font-bold text-sky-600 border-t sm:border-t-0 pt-2 sm:pt-0'}, formatNumber(currentPrice)+'ì›'));
    itemDiv.appendChild(el('div',{class:`text-right w-full sm:w-auto text-sm font-bold border-t sm:border-t-0 pt-2 sm:pt-0 ${p.sold ? 'text-green-600' : 'text-gray-400'}`}, winningPrice));
    const statusActionDiv = el('div',{class:'col-span-2 text-right w-full border-t sm:border-t-0 pt-2 sm:pt-0 space-y-1'});
    statusActionDiv.appendChild(status);
    statusActionDiv.appendChild(actions);
    itemDiv.appendChild(statusActionDiv);
    list.appendChild(itemDiv);
  });

  wrap.appendChild(list);
  return wrap;
}

/* ì´ë¯¸ì§€ ì—…ë¡œë“œ ë”ë¯¸ (ì›ë³¸ ìœ ì§€: placeholder urls) */
const uploadImg = (files) => new Promise(resolve=>{
  const urls = Array.from(files).map((f,i)=>`https://placehold.co/600x400/e0f2fe/0284c7?text=Image+${i+1}`);
  setTimeout(()=> resolve(urls), 400);
});

/* ìë™ í•˜ì´í”ˆ (íœ´ëŒ€í°) */
function autoHyphen(target){
  target.value = target.value.replace(/[^0-9]/g,'').replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);
}

/* ìë™ ë¡œê·¸ì¸ (ë°ëª¨ ì „ìš©) â€” DEMO í”Œë˜ê·¸ë¡œ ì œì–´ */
const DEMO = true;
loadSession();
if(DEMO && !state.session){
  const demoUser = loadUsers().find(u=>u.email==='demo@user.com');
  if(demoUser){
    saveSession({email:demoUser.email, name:demoUser.name});
    state.session = {email:demoUser.email, name:demoUser.name};
    state.view='list';
  }
}

/* í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • (ê¸´ ì œëª©) */
function adjustTextSizes(){
  document.querySelectorAll('.shrink-text-container').forEach(container=>{
    const textElement = container.querySelector('.shrink-text');
    if(!textElement) return;
    // CSS multiline clamp used; nothing to do here for now
  });
}

/* ìœ í‹¸: get user name / masked name */
function getUserName(email){ return loadUsers().find(u=>u.email===email)?.name || 'ìµëª…'; }
function getMaskedName(email){
  const name = getUserName(email);
  if(!name) return 'ìµëª…';
  if(name.length > 1) return name[0] + '*'.repeat(Math.max(0, name.length - 2)) + name[name.length - 1];
  return name;
}

/* ì…ì°° ì²˜ë¦¬ */
function placeBid(id){
  if(!state.session) return toast('ë¡œê·¸ì¸ í›„ ì…ì°°í•˜ì„¸ìš”');
  const product = state.products.find(item => item.id === id);
  if(!product) return toast('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  const amountStr = document.getElementById('bidAmount')?.value || '';
  const amount = parseFormattedNumber(amountStr);
  if(!amount || amount <= 0) return toast('ì…ì°°ê°€ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');

  if(product.type === 'event'){
    // Duplicate bid prevention
    if(product.bids.some(b => b.price === amount)){
        return toast('ì´ë¯¸ ì„ íƒëœ ê¸ˆì•¡ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
    }

    const isEventBidToday = product.bids.some(b => b.user === state.session.email && fmtDate(b.time) === fmtDate(new Date()));
    if(isEventBidToday) return toast('ì´ë²¤íŠ¸ ê²½ë§¤ëŠ” í•˜ë£¨ì— í•œ ë²ˆë§Œ ì…ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    const start = product.eventRangeStart, end = product.eventRangeEnd;
    if(amount < start || amount > end) return toast(`ì´ë²¤íŠ¸ ê²½ë§¤ëŠ” ${formatNumber(start)}ì›ë¶€í„° ${formatNumber(end)}ì› ì‚¬ì´ì˜ ê¸ˆì•¡ë§Œ ì…ì°° ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
  } else {
    const current = product.bids?.length ? product.bids[product.bids.length-1].price : product.startingPrice;
    if(amount <= current) return toast('í˜„ì¬ ìµœê³ ê°€ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡ìœ¼ë¡œ ì…ì°°í•˜ì„¸ìš”.');
  }

  product.bids.push({user: state.session.email, price: amount, time: new Date().toISOString()});
  saveProducts();
  toast('ì…ì°°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
  render();
}

/* ì¦‰ì‹œêµ¬ë§¤ ì²˜ë¦¬ (ë„¤ì´ë° ì¶©ëŒ ë°©ì§€: handleBuyNow) */
function handleBuyNow(id){
  if(!state.session) return toast('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”');
  const product = state.products.find(item => item.id === id);
  if(!product || !product.buyNow) return toast('ì¦‰ì‹œêµ¬ë§¤ ë¶ˆê°€');
  if(confirm(`ì¦‰ì‹œêµ¬ë§¤ ${formatNumber(product.buyNow)}ì› í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
    product.sold = true;
    product.winner = state.session.email;
    product.winningPrice = product.buyNow;
    product.bids.push({user: state.session.email, price: product.buyNow, time: new Date().toISOString()});
    saveProducts();
    toast('ì¦‰ì‹œêµ¬ë§¤ ì™„ë£Œ! ì¶•í•˜í•©ë‹ˆë‹¤.');
    render();
  }
}

/* ìƒí’ˆ ì‚­ì œ */
function deleteProduct(id){
  if(!confirm('ì •ë§ë¡œ ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')) return;
  state.products = state.products.filter(p => p.id !== id);
  saveProducts();
  toast('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  state.view='mySales';
  render();
}

/* ==================================================
   ì´ˆê¸° ë Œë”
   ================================================== */
render();

</script>
</body>
</html>
